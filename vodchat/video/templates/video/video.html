{% extends "users/base.html" %}
{% block content %}
<h1>{{video.title}}</h1>
<div id="commentArea" class="overflow-auto" style="max-height: 100px;">
{%for c in video.comment_set.all%}
<div style="display:none">
    <div class = "myTime">{{c.time}}</div>
    {{c.text}}
</div>
<!-- <p style="display:none" class = "myTime">{{c.time}}</p></br> -->
{%endfor%}
</div>
<video id="myVideo" controls>
    <source src="{{video.video.url}}" type="video/mp4">
</video>
<p>Description: {{video.description}}</p>


Comment: <input type="text" id= 'chat-message-input' name="comment"/></br>
<input id="chat-message-submit" type="button" value="Send"/>

{% endblock %}
{% block javascript %}

<script>
    var myVid=document.getElementById("myVideo");
    
    function update()
    {
        // var currentTime = myVid.played.end(0);
        var currentTime = myVid.currentTime;
        var times = document.getElementsByClassName("myTime");
        var i;
        for (i = 0; i < times.length; i++) {
            var t=parseFloat(times[i].innerHTML);
            if(currentTime>=t&&currentTime<=t+10)
            {
                times[i].parentElement.style.display = "block";
            }
            else
            {
                times[i].parentElement.style.display = "none";
            }
        }
        var div = document.getElementById("commentArea");
        div.scrollTop = div.scrollHeight - div.clientHeight;
    }
    
    var video_id = "{{ video.id }}";
    
    var chatSocket = new WebSocket(
            'ws://' + window.location.host +
            '/ws/video/' + video_id + '/');
    
    chatSocket.onmessage = function(e) {
            var data = JSON.parse(e.data);
            var message = data['message'];
            var time = data['time'];
            var commentDiv=document.createElement("div");
            var timeDiv=document.createElement("div");
            timeDiv.innerHTML = time
            var messageNode = document.createTextNode(message)
            commentDiv.appendChild(timeDiv)
            commentDiv.appendChild(messageNode)
            commentDiv.style.display = "block";
            var times = document.getElementsByClassName("myTime");
            var i;
            for (i = 0; i < times.length; i++) {
                var t=parseFloat(times[i].innerHTML);
                if (parseFloat(time) >= t) {
                    break;
                }
                //document.getElementById("commentArea").appendChild(commentDiv);
            }
            document.getElementById("commentArea").insertBefore(commentDiv, times[i].parentElement)
            
        };
    
    chatSocket.onclose = function(e) {
            console.error('Chat socket closed unexpectedly');
    };
    
    document.getElementById('chat-message-input').focus();
    document.getElementById('chat-message-input').onkeyup = function(e) {
    if (e.keyCode === 13) {  // enter, return
                document.getElementById('chat-message-submit').click();
            }
    };
    
    document.getElementById('chat-message-submit').onclick = function(e) {
            var messageInputDom = document.getElementById('chat-message-input');
            var message = messageInputDom.value;
            chatSocket.send(JSON.stringify({
                'message': message,
                'time':myVid.currentTime
            }));
    
            messageInputDom.value = '';
    };
        
    setInterval(update, 100);
    </script>

{% endblock %}